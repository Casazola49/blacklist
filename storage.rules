rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Archivos de contratos: solo cliente y especialista asignado pueden acceder
    match /contratos/{contratoId}/{allPaths=**} {
      allow read, write: if request.auth != null &&
        (request.auth.uid in resource.metadata.allowedUsers);
    }
    
    // Archivos de chat: solo participantes pueden acceder
    match /chats/{chatId}/{allPaths=**} {
      allow read, write: if request.auth != null &&
        (request.auth.uid in resource.metadata.participants);
    }
    
    // CVs de especialistas: solo el propietario puede escribir, admins pueden leer
    match /cvs/{userId}/{allPaths=**} {
      allow write: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null && 
        (request.auth.uid == userId ||
         exists(/databases/(default)/documents/usuarios/$(request.auth.uid)) &&
         get(/databases/(default)/documents/usuarios/$(request.auth.uid)).data.tipo == 'admin');
    }
    
    // Avatares de usuario: solo el propietario puede escribir, todos pueden leer
    match /avatars/{userId}/{allPaths=**} {
      allow write: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null;
    }
  }
}